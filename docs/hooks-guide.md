# Claude Code Hooks ガイド
> `.claude/hooks/` に何が入ってるの？を全部わかりやすく解説します

---

## そもそも「Hooks」って何？

Claude Code には **イベントフック** という仕組みがあります。

> 「Claude が何かをしたとき、自動的に別のスクリプトを実行できる」

たとえばこんなことができます：
- ユーザーがメッセージを送信したとき → **音声を再生する**
- サブエージェントが起動したとき → **専用ボイスでセリフを読み上げる**

このプロジェクトでは Hooks を使って **AI キャラクターたちが声でリアクションする** 演出を実現しています。

---

## 全体の流れ（大まかなイメージ）

```
あなたがメッセージ送信
    ↓
🔔 on-user-prompt.js が発火 → プロンプトを読み上げ

Claudeがサブエージェント(Task)を呼び出す
    ↓
🔔 on-task-start.js が発火 → 「〇〇ちゃん、〜をお願い！」＋受諾セリフを読み上げ

サブエージェントが作業完了
    ↓
🔔 on-stop.js が発火 → エージェントの声で完了報告を読み上げ

Claudeのメイン処理が完了
    ↓
🔔 on-main-stop.js が発火 → 「全ての作業が完了したよ！」を読み上げ
```

---

## ファイル一覧

```
.claude/
├── settings.json         ← フックの登録設定ファイル（どのイベントでどのスクリプトを動かすか）
└── hooks/
    ├── on-user-prompt.js ← ユーザーがメッセージ送信したとき
    ├── on-task-start.js  ← サブエージェント起動直前
    ├── on-stop.js        ← サブエージェント完了時
    ├── on-main-stop.js   ← メインエージェント完了時
    └── hook-log.jsonl    ← 全イベントの動作記録ログ
```

---

## settings.json ― フックの「配線図」

```json
{
  "hooks": {
    "UserPromptSubmit": [ → on-user-prompt.js ],
    "PreToolUse(Task)":  [ → on-task-start.js  ],
    "SubagentStop":      [ → on-stop.js        ],
    "Stop":              [ → on-main-stop.js   ]
  }
}
```

| イベント名 | タイミング | 実行スクリプト |
|---|---|---|
| `UserPromptSubmit` | ユーザーがメッセージ送信した直後 | `on-user-prompt.js` |
| `PreToolUse` (Taskのみ) | サブエージェント起動の直前 | `on-task-start.js` |
| `SubagentStop` | サブエージェントが完了したとき | `on-stop.js` |
| `Stop` | メインClaudeが完了したとき | `on-main-stop.js` |

---

## 各スクリプトの詳細

### 1. `on-user-prompt.js` ― ユーザーのメッセージ受取時

**いつ動く？** → あなたがメッセージを送信したとき

**何をする？**

```
1. hook-log.jsonl にログを記録する
2. Aivis Cloud API で音声合成して再生する（macOSのみ）
   ├─ メッセージが50文字以下 → そのまま読み上げ
   └─ 50文字超  → 「了解！タスクを受け取ったよ、すぐやるね！」と言う
```

**読み上げる声**：メインボイス（Claude の声）

---

### 2. `on-task-start.js` ― サブエージェント起動時

**いつ動く？** → Claude が Task ツールでサブエージェントを呼び出す直前

**何をする？**

```
1. hook-log.jsonl にログを記録する
2. 2段階アナウンスを再生する：
   [メイン声] 「るなちゃん、コンポーネント実装をお願い〜！」
   [サブ声]   「うちに任せて！！まじやばくない！？」
```

**エージェント別の声と受諾セリフ：**

| エージェント | 役割 | 依頼フレーズ | 受諾セリフ |
|---|---|---|---|
| `luna-coder` | 実装担当 | 「るなちゃん、〜をお願い〜！」 | 「うちに任せて！！まじやばくない！？」 |
| `tsubaki-reviewer` | レビュー担当 | 「椿ちゃん、〜をお願い！」 | 「べ、別にあなたのためじゃないけど…仕方ないからやってあげるわよ。」 |
| `hinata-explorer` | 調査担当 | 「ひなたちゃん、〜を調べてきて〜！」 | 「わかった！やってみる！！絶対見つけてくるね！！」 |
| `rin-planner` | 設計担当 | 「凛ちゃん、〜を設計してきてね！」 | 「かしこまりました。手順通りに進めます。」 |
| `yui-debugger` | デバッグ担当 | 「ゆいちゃん、〜を調べてお願い！」 | 「…了解。すぐ調べる。」 |

---

### 3. `on-stop.js` ― サブエージェント完了時

**いつ動く？** → サブエージェントが作業を終えたとき

**何をする？**

```
1. hook-log.jsonl にログを記録する
2. エージェントの最後のメッセージから <report>タグ</report> の中身を抽出
3. そのエージェントの専用ボイスで完了報告を読み上げる
   ※ <report>タグがない場合はスキップ（読み上げなし）
```

**<report>タグって何？**

サブエージェントが作業完了時に以下のような形式で報告を出します：

```
<report>コンポーネントの実装が完了しました！</report>
```

このタグの中身だけを抽出して、そのエージェントの声で読み上げます。

---

### 4. `on-main-stop.js` ― メインClaude完了時

**いつ動く？** → Claude のメイン処理が全部終わったとき

**何をする？**

```
1. hook-log.jsonl にログを記録する
2. メインボイスで完了を読み上げる
   ├─ <report>タグがあれば → その内容を読み上げ
   └─ なければ → 「全ての作業が完了したよ！お疲れさまでした！」
```

---

## 音声合成の仕組み

[Aivis Cloud API](https://aivis-project.com/) を使って日本語テキストを音声に変換しています。

```
Claude (Node.js スクリプト)
    ↓ HTTP POST (JSON)
Aivis Cloud API
    ↓ MP3 データ
一時ファイルに保存 (/tmp/tts-audio-xxx.mp3)
    ↓ afplay コマンド（macOS標準）
スピーカーから再生
    ↓ 再生完了後
一時ファイル削除
```

**キャラクターごとの声 (UUID)：**

| キャラクター | UUID |
|---|---|
| メイン（Claude） | `9107b8b6-...` |
| 椿 (tsubaki-reviewer) | `22e8ed77-...` |
| るな (luna-coder) | `e9339137-...` |
| その他3名 | メインと同じ UUID |

---

## hook-log.jsonl ― ログファイル

全てのフック動作が JSON Lines 形式で記録されます。

```json
{"timestamp":"2026-02-27T00:00:00.000Z","event":"UserPromptSubmit","sessionId":"abc123","promptLength":42}
{"timestamp":"2026-02-27T00:00:01.000Z","event":"tts-curl-start","text":"了解！タスクを受け取ったよ"}
{"timestamp":"2026-02-27T00:00:03.000Z","event":"tts-done"}
```

**記録されるイベント一覧：**

| event | 意味 |
|---|---|
| `UserPromptSubmit` | ユーザーがメッセージ送信 |
| `TaskStart` | サブエージェント起動 |
| `SubagentStop` | サブエージェント完了 |
| `MainStop` | メインエージェント完了 |
| `tts-curl-start` | 音声合成リクエスト開始 |
| `tts-curl-done` | 音声合成レスポンス受信 |
| `tts-done` | 再生完了 |
| `tts-skip` | 再生スキップ（タグなし・環境非対応など） |
| `tts-error` | エラー発生 |

---

## 全体のシーケンス図

```
あなた          Claude (メイン)     サブエージェント    Aivis API
  |                  |                    |               |
  |-- メッセージ送信 -->|                    |               |
  |             [UserPromptSubmit フック]                  |
  |                  |--------- テキスト送信 ------------->|
  |                  |<-------- MP3 返却 ----------------|
  |                  |== 再生 ==|                          |
  |                  |                    |               |
  |            [Task ツール呼び出し]       |               |
  |              [PreToolUse フック]      |               |
  |                  |-- 「るなちゃん、〜お願い！」 ------->|
  |                  |<-------- MP3 返却 ----------------|
  |                  |== 再生 ==|                          |
  |                  |-- 「うちに任せて！」（るな声）------>|
  |                  |<-------- MP3 返却 ----------------|
  |                  |== 再生 ==|                          |
  |                  |                    |               |
  |                  |------起動--------->|               |
  |                  |                 [作業中]            |
  |                  |<----完了 + report--|               |
  |             [SubagentStop フック]                      |
  |                  |-- report テキスト（るな声）-------->|
  |                  |<-------- MP3 返却 ----------------|
  |                  |== 再生 ==|                          |
  |                  |                    |               |
  |            [メイン処理完了]           |               |
  |              [Stop フック]            |               |
  |                  |-- 「お疲れさまでした！」 ----------->|
  |                  |<-------- MP3 返却 ----------------|
  |                  |== 再生 ==|                          |
```

---

## まとめ

| ファイル | 役割 |
|---|---|
| `settings.json` | 「どのイベントでどのスクリプトを動かすか」の設定 |
| `on-user-prompt.js` | あなたのメッセージをメイン声で読み上げ |
| `on-task-start.js` | サブエージェント起動を2段階ボイスで演出 |
| `on-stop.js` | サブエージェントの完了報告をそのキャラの声で再生 |
| `on-main-stop.js` | 全作業完了をメイン声でお知らせ |
| `hook-log.jsonl` | 全動作の記録（デバッグ用） |

要するに、**Claude Code の Hooks 機能を使って「AIキャラクターが音声でリアクションする」体験を実現している**仕組みです！
